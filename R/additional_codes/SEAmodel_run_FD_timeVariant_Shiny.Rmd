---
title: "SEAmodel_run_FD"
author: "Camilla Novaglio"
date: "15/11/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# key folders: 

# summary of communities: 

#-----------------------------------------
# Load code and data produced in SEmodel_run  
#-----------------------------------------

```{r codes}

rm(list=ls())

# 3 options according to the SEAmodel_run.Rmd
# load("/Users/nov017/Dropbox/Mizer-fleet/R/model/tempData.RData") # now SEAmodel_opn1.RData.
# load("/Users/nov017/Dropbox/Mizer-fleet_extension/data/tempData_Oct.RData") # now SEAmodel_opn2.RData
# load("/Users/nov017/Dropbox/Mizer-fleet/R/model/SEAmodel_opn3.RData") # before tempData_Nov.RData

# now changed folder 
load("/Users/nov017/Dropbox/Mizer-fleet_extension/data/SEAmodel_opn3.RData") 

library(tidyverse)
library(devtools)
library(plyr) 
library(Rcpp) # this will allow you to run the inner_project_loop 
library(reshape2)
library(inline)
library(ggplot2)
library(vegan)
# install.packages("shiny")
library(mizer) # if inner_loop error, you need to upload mizer
library(shiny)

setwd("/Users/nov017/R-projects/Mizer-fleet/R")
source("data.R") 
source("help.R") 
source("MizerParams-class.R") 
source("MizerSim-class.R")
source("plots.R")
source("project_methods.R")
source("project.R")
source("RcppExports.R") 
source("selectivity_funcs.R")
source("summary_methods.R")
source("wrapper_functions.R")
source("DataFunction.R") 

```

#-----------------------------------------
# (re)calculate df_target
#----------------------------------------------

```{r}

# See SEA_FleetParam.Rmd option 3 (calcualte Q from catches) line 634 for ref 

# filter speceies and metiers before calculating target matrix 
df_main_metier<-c("GHAT - Southern Shark Gillnet","South East Trawl Fishery - Danish Seine","South East Trawl Fishery - Otter trawl shelf","South East Trawl Fishery - Otter trawl upperSlope", "South East Trawl Fishery - Otter trawl deepSlope") 

catch <- df_log_spp %>%
  filter(metier %in% df_main_metier) %>% 
  filter(SPC_NAME %in% df_param$species) %>%  
  group_by(SPC_NAME, metier) %>%
  dplyr::summarize(
    catch_kg = sum(TOT_CATCH_KG, na.rm=TRUE)
  ) %>% 
  `colnames<-`(c("species","metier", "catch_kg"))

# add spp missing from catch data
other_spp<-expand.grid(unique(df_param$species), unique(catch$metier))
colnames(other_spp)<-c("species","metier")
catch<-merge(catch, other_spp, all = TRUE)
catch[is.na(catch$catch_kg),"catch_kg"]<-0

# option 2 - consider speceis (instead of fleets)
df_qcatch<-split(catch, catch$species)

# calcualte proportions by speceis
for(i in 1:length(df_qcatch)){
  mi = sum(df_qcatch[[i]]$catch_kg)
  df_qcatch[[i]]$catch_prop<-(df_qcatch[[i]]$catch_kg/mi)
}

df_qcatch<-data.frame(do.call("rbind",df_qcatch))
rownames(df_qcatch)<-NULL
df_qcatch<-df_qcatch[,-which(colnames(df_qcatch) =="catch_kg")]
colnames(df_qcatch)<-c("species","subfleet","target") 
df_qcatch[which(df_qcatch$species %in% c("myctophids")),"target"]<-0 

# change fleet names
df_qcatch<-df_qcatch %>% 
  mutate(subfleet = case_when(subfleet == "GHAT - Southern Shark Gillnet" ~ "SSG",
                              subfleet == "South East Trawl Fishery - Danish Seine" ~ "SED",
                              subfleet == "South East Trawl Fishery - Otter trawl deepSlope" ~ "SET-DS",
                              subfleet == "South East Trawl Fishery - Otter trawl shelf" ~ "SET-SH",
                              subfleet == "South East Trawl Fishery - Otter trawl upperSlope" ~ "SET-US"))

# target and Q don't have the spp order right, but are fixed in Mizerparams-class
df_target = acast(df_qcatch, formula = subfleet ~ species, value.var = "target")
df_target<-df_target[,colnames(relative_effort)]

# this is what will be used in all function to sort fleets 
fleet = rownames(df_target)

# plot matrix
target_plot<-df_qcatch %>%
  right_join(df_param[c(1,2)])

p_target <- ggplot(target_plot, aes(spCommon,subfleet)) +
  geom_tile(aes(fill = target)) +
  scale_fill_gradient(low = "white",high = "blue")+
  theme_bw()+
  theme(text = element_text(size=18),
        axis.text.x = element_text(angle=90, hjust=0.5),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())

# adjust df_target to include catchability in df_param ...  
# df_target<-as.data.frame(df_target) %>%
#   mutate(fleet = rownames(df_target)) %>% 
#   gather(species, q, -fleet) %>% 
#   left_join(df_param[,c("species", "catchability")]) %>% 
#   mutate(q = q*catchability) %>% 
#   select(-catchability) %>% 
#   spread(species, q)
# rownames(df_target)<-df_target$fleet
# df_target<-df_target %>% select(-fleet)
# df_target<-as.matrix(df_target)

```

#-----------------------------------------
# adjust df_selParam_new, df_price_new, df_cost2
#----------------------------------------------

```{r}

# keep only spp and fleets specified above
df_selParam_new<-df_selParam %>% 
  filter(species %in% df_param$species, 
         subfleet %in% df_main_metier) %>% 
  mutate(subfleet = case_when(subfleet == "GHAT - Southern Shark Gillnet" ~ "SSG",
                              subfleet == "South East Trawl Fishery - Danish Seine" ~ "SED",
                              subfleet == "South East Trawl Fishery - Otter trawl deepSlope" ~ "SET-DS",
                              subfleet == "South East Trawl Fishery - Otter trawl shelf" ~ "SET-SH",
                              subfleet == "South East Trawl Fishery - Otter trawl upperSlope" ~ "SET-US"))

df_price_new<-df_price %>% 
  filter(species %in% df_param$species)

# add values for 2017
addPrice2017<-df_price_new %>% 
  filter(year == "2016") %>% 
  mutate(year = "2017")
df_price_new<-rbind(df_price_new, addPrice2017)

# matrix of prices
df_price_new = spread(df_price_new, species, price)
rownames(df_price_new)<-df_price_new$year
df_price_new<-df_price_new[,-1]
df_price_new<-as.matrix(df_price_new)
df_price_new<-df_price_new[, df_param$species] # order spp

# cost - can have differnt units 
# df_cost = df_cost_g $ opn-1 g-1
# df_cost2 = df_cost_opn $ opn-1

# divide fixed and variable costs - variable costs vary with the amount of fishing effort or catch, and fixed costs do not vary with effort (Pascoe 2014)

# After chat with Beth and Ingrid - use cost/g - still need to figure out units in eqn... 

df_cost2<-df_cost_opn %>% 
  filter(subfleet %in% df_main_metier) %>% 
  mutate(cost_type = ifelse(param_type %in% c("Crew","Fuel","Packaging","Freight"), "fixed", "variable")) %>% 
  group_by(subfleet, year, cost_type) %>%  
  dplyr::summarise(cost = sum(param_value, na.rm=TRUE)) %>% 
  mutate(subfleet = case_when(subfleet == "GHAT - Southern Shark Gillnet" ~ "SSG",
                              subfleet == "South East Trawl Fishery - Danish Seine" ~ "SED",
                              subfleet == "South East Trawl Fishery - Otter trawl deepSlope" ~ "SET-DS",
                              subfleet == "South East Trawl Fishery - Otter trawl shelf" ~ "SET-SH",
                              subfleet == "South East Trawl Fishery - Otter trawl upperSlope" ~ "SET-US"))

# cost need to have the same years as price - temporary values here 
addCost2015<-df_cost2 %>% 
  filter(year == "2014") %>% 
  mutate(year = "2015")
addCost2016<-addCost2015 %>% 
  mutate(year = "2016")
addCost2017<-addCost2015 %>% 
  mutate(year = "2017")
df_cost2<-rbind(df_cost2,addCost2015,addCost2016, addCost2017)

# matrix of costs
df_cost2<-acast(df_cost2, formula = year ~ subfleet ~ cost_type, value.var = "cost") 
df_cost2<-df_cost2[,rownames(df_target),] # order cost by fleet

# OPTION 1 use costs in g or use costs per opn rescaled as per Beth's data
# Beth's adjustment on costs - see email 'price' and file 'costs_from_SESSF_2005'

# ref<- df_cost2[,3,1] # trawlers on the shelf
# df_cost2[,1,1]<-ref*1.5 # Danish seiners - see agenda, could be *0.6 or *1.5?
# df_cost2[,2,1]<-ref*0.67 # deep slope
# df_cost2[,4,1]<-ref*0.67 # upper slope - these is the fishery using the biggers adn more expensive boats, so if you are using the costs per operation unit, this should be highest
# df_cost2[,5,1]<-ref*0.94 # gillnet
# 
# ref<- df_cost2[,3,2] # trawlers on the shelf
# df_cost2[,1,2]<-ref*1.5 # Danish seiners
# df_cost2[,2,2]<-ref*0.67 # deep slope
# df_cost2[,4,2]<-ref*0.67 # upper slope
# df_cost2[,5,2]<-ref*0.94 # gillnet

# according to 'prices' email from Beth
ref<- df_cost2[,3,1] # trawlers on the shelf
df_cost2[,1,1]<-ref*0.6 # Danish seiners - see agenda, could be *0.6 or *1.5? - not sure about this but usually smaller boat?
df_cost2[,2,1]<-ref*3.3 # deep slope
df_cost2[,4,1]<-ref*3.3 # upper slope - these is the fishery using the biggers adn more expensive boats, so if you are using the costs per operation unit, this should be highest
df_cost2[,5,1]<-ref*0.14 # gillnet

ref<- df_cost2[,3,2] # trawlers on the shelf
df_cost2[,1,2]<-ref*0.6 # Danish seiners
df_cost2[,2,2]<-ref*2.36 # deep slope
df_cost2[,4,2]<-ref*2.36 # upper slope
df_cost2[,5,2]<-ref*0.04 # gillnet

```

#-----------------------------------------
# Set fixed parameters
#----------------------------------------------

```{r}

kappa = kappa # intercpet of PP
kappa_ben = kappa_ben # intercpet of BB benthic spectrum
kappa_alg = kappa_alg # intercpet for algae spectrum
lambda = 2.33 # slope of spectrum - def
lambda_ben = 2.33 # slope of spectrum - def
w_pp_cutoff = w_pp_cutoff 
min_w_bb = min_w_bb
w_bb_cutoff = w_bb_cutoff  
n = 2/3 # Exponent for max. food intake - def
q = 0.8 # Exponent for volumetric search rate - def
dt = 0.25
no_w = 100 # def

```

#-----------------------------------------
# Calculate biomass reference levels  
#----------------------------------------------

```{R}

# Calculate biomass reference levels (Bref, Bmsy, Bhist) 
source("/Users/nov017/R-projects/Mizer-fleet/R/DataFunction.R") 
Blevel<-getBlevel(sim_calibrated_unfished,matrix_effort_nofishing,constant_effort,sim_calibrated,df_param,sim_fitted)
bioUnfished = Blevel$bioUnfished 
msy = Blevel$msy
plot = Blevel$p
Bhist = Blevel$Bhist

# add bioUnfished, Bmsy and Bhist, B0 as per SA to df_param 
df_param<-df_param %>% 
  left_join(select(msy, c(species, Bmsy))) %>% 
  left_join(select(Bhist, c(species, Bhist))) %>% 
  left_join(bioUnfished %>% dplyr::rename(Bref = bioUnfished)) %>% 
  mutate(B0_SA = (getBiomass(sim_calibrated)[200,])*100/df_param$changesSSB)

# plot values
bio<-df_param %>%
  select(species, Bref,Bmsy,Bhist,B0_SA) %>%
  mutate(bioMod = getBiomass(sim_calibrated)[200,])

bio_plot<-bio %>% gather(variable, value, -species)

p<-ggplot(bio_plot, aes(x = variable, y = value))+
    geom_point()+
    facet_wrap(~species, scale ="free_y")+
    theme(axis.text.x = element_text(size=10, angle = 90, hjust=0.5))

# check reference levels. using Bmsy and Bhist, fishing is more likely to happen
# bio$fishing<-ifelse(bio$bioMod<bio$Bmsy*0.5, "no fishing", "")

#### FIG S1
setwd("/Users/nov017/Dropbox/Mizer-fleet_extension/plot/FD/Final")
tiff("FigS1_May2020.tiff", height=6, width=10, units ='in', res=300)
plot
dev.off()

```

#-----------------------------------------
# Calculate scaling costs and price  
#---------------------------------------------- 

```{r}

# scaling cost area - to get units right
# from costs in $ g-1 opn-1 to costs in $ g-1 m-3
# m3 fished in a tralwing operation:
scaling_cost_area = 14000*10*20 # SESSFdataCleaning (trawling+gillnet opn) m trawled*net opening: 20m *10m
scaling_cost_area = scaling_cost_area*5000 # interpretation: soak time for a net (Beth) - this determines cost but also initial effort!- can we used it only for effort and not costs - as now justification it fishes some individuals but not the ones sold? 
df_cost3<-df_cost2
df_cost3[]<-df_cost3/scaling_cost_area # if costs  are $ *g, than this is not needed

# scaling costs - MAKE + PROFITS to start with 
scaling_costs<-c(0.05,0.03,0.2,0.1,1) # interpretation: subsidies?
# scaling_costs<-rep(1,5) #
# scaling_costs<-c(0.000001,1,1,1,1) # making SED very cheap to run -> positive profits -> increase in effort if no spp < 40%
df_cost3[,1,] = df_cost3[,1,]*scaling_costs[1] 
df_cost3[,2,] = df_cost3[,2,]*scaling_costs[2]
df_cost3[,3,] = df_cost3[,3,]*scaling_costs[3]
df_cost3[,4,] = df_cost3[,4,]*scaling_costs[4]
df_cost3[,5,] = df_cost3[,5,]*scaling_costs[5]

# scaling price
scaling_price<-1
df_price_new[]<-df_price_new*scaling_price

```

#-----------------------------------------
# Calcualte fleet param (ke_fleet, initial effort, scaling effort) 
#----------------------------------------------

```{r}

# ke_fleet is effective only if no spp below 40 or if decreases in profit would result in higher decreases than those due to management. The lower ke, the lower the rate of change - ke increases or decreases profits more thus exhacerbate whicever trend happening  
ke_fleet = data.frame(fleet= rownames(df_target), ke = rep(1, 5)) 
ke_fleet = data.frame(fleet= rownames(df_target), ke = rep(100000, 5)) 
ke_fleet = data.frame(fleet= rownames(df_target), ke = c(100000,100000,100000,100000,100000))

# initial effort (from data)
# see campareTrends for more info on how effort data is treated and plotted.
# can sum(initial_effort) be >1 ? what is the meaning? 
trial<-datValidationEffort %>% 
  ungroup() %>% 
  mutate(opn = (opn*scaling_cost_area)/areaEco) %>% # from opn to m3 trawled in m3
  filter(YEAR == 2006)
trial<-trial[c(3,4,5,6,1),] # reorder fleets
initial_effort = trial$opn

# scaling effort
scaling_effort<-rep(1,5)
initial_effort = initial_effort*scaling_effort 

```

#-----------------------------------------
# Tune Q *opn2 - obsolete*
#----------------------------------------------

```{r}

# initial_effort*df_target needs to be on the scale of relative_effort
colSums(df_target*initial_effort) # this is based on catch and effort data
relative_effort[212,] # this is Fmort from SA (or catches)

# df_target is not real Q as the one incorporated in Fmort, it sums to 1 and is a proportion of how much each fleet cacthes the whole papolation available.
df_target_bmsy <- df_target

# for squid and tracurus, df_target assumes these spp are fished by the fleets indicated here. but they are not and their catchability is usiually quite low - here represented as food
df_target_bmsy[, "nototodarus gouldi"]<- df_target_bmsy[, "nototodarus gouldi"]/25
df_target_bmsy[, "trachurus declivis"]<- df_target_bmsy[, "trachurus declivis"]/40

# OPTION 1 fix upper slope
df_target_bmsy[4, "seriolella punctata"]<- df_target_bmsy[4, "seriolella punctata"]/2

# OPTION 2 fix shelf - move target from shelf to sed
df_target_bmsy[3, "centroberyx affinis"]<- df_target_bmsy[3, "centroberyx affinis"]/2
df_target_bmsy[3, "nemadactylus macropterus"]<- df_target_bmsy[3, "nemadactylus macropterus"]/2
df_target_bmsy[3, "seriolella brama"]<- df_target_bmsy[3, "seriolella brama"]/2

# OPTION 4 fix sed increase catch by moving some spp from shelf to sed
df_target_bmsy[1, "centroberyx affinis"]<- df_target_bmsy[1, "centroberyx affinis"]*500
df_target_bmsy[1, "nemadactylus macropterus"]<- df_target_bmsy[1, "nemadactylus macropterus"]*10
df_target_bmsy[1, "seriolella brama"]<- df_target_bmsy[1, "seriolella brama"]*50

# OPTION 5 increase sed effort by removing some declning spp - need to reduce these as much as possible
df_target_bmsy[1, "helicolenus barathri"]<- 0
df_target_bmsy[1, "seriolella punctata"]<- 0
df_target_bmsy[1, "galeorhinus galeus"]<- 0
df_target_bmsy[1, "squalus spp."]<- 0
df_target_bmsy[1, "centroberyx affinis"]<- 0

# OPTION 6 decrease catches in US
# df_target_bmsy[4, "macruronus novaezelandiae"]<- df_target_bmsy[4, "macruronus novaezelandiae"]/1.5
df_target_bmsy[4, "helicolenus barathri"]<- df_target_bmsy[4, "helicolenus barathri"]/2 # could increase this to 8 as this spp is not an important one? but need to think mode of this
df_target_bmsy[4, "galeorhinus galeus"]<- 0
df_target_bmsy[4, "centroberyx affinis"]<- df_target_bmsy[4, "centroberyx affinis"]/2

# OPTION 7 - decrease shelf catch
df_target_bmsy[3,]<-df_target_bmsy[3,]*0.8

# OPTION 8 - decrease blue w
# df_target_bmsy[1, "seriolella brama"]<- df_target_bmsy[1, "seriolella brama"]*0.1
# df_target_bmsy[3, "seriolella brama"]<- df_target_bmsy[3, "seriolella brama"]*0.1
# df_target_bmsy[4, "seriolella brama"]<- df_target_bmsy[4, "seriolella brama"]*4
# df_target_bmsy[5, "seriolella brama"]<- df_target_bmsy[5, "seriolella brama"]*0.1

# BETH:
# need to fix blue wharehow (seriorelle b.) -> reduce bycatch from other fisheries
# need to fix flathead -> catch are increasing
# check increasing abundances - if not realistic you need to change growth parameters and/or recruitment param - see sharks as they all recover to 1995 (modelled) values - though 1995 is a 'depleted' year/abundance

# 2 problems with flathead: 1) Fmort in 2006 is much lower than for the Fmort model:
colSums(df_target_bmsy*initial_effort)
relative_effort[212,]

colSums(df_target*initial_effort)
relative_effort[212,]

# I can
# a) increase Q for SED by 8 time. That results in about the same Fmort and fixes the flathead trend. BUT total Q for flathead is Q is 3.7!; trends in whiting is not great as well as trends at teh fleet level in particular for SED
# df_target_bmsy[1,"platycephalus richardsoni"]<-df_target_bmsy[1,"platycephalus richardsoni"]*8
# b) increase effort for e.g. SED (or SET) and decrease Q for all spp but flathed. BUT the effort plots won't look as good and initial effort is not based on data any longer

# 2 predation release from squid, which declines (larvae predation as squid eats fish individuals that are ~12 g not sharks as they enter the community at a much higher weight)
# theta2<-theta
# theta2["nototodarus gouldi",]
# theta2["nototodarus gouldi","platycephalus richardsoni"]<-3
# I can
# a) increase predation from other small fish. but this is very slightly effective
# theta2["sillago flindersi","platycephalus richardsoni"]<-1

# to conclude: the problem is a combination of fishing mortality being low and predation being low so that the population increases. An important problem with both model is that flathead abundance is well underestimated (~ 5000t in model and 20000 t in SA - I remember the problem with flathead in the Fmort model being tat increases in this spp lead to decreases/collapses/increases of squalus).

```

#-----------------------------------------
# tune Q *opn3 - better*
#----------------------------------------------

```{r}

# compareTrends(sim_fitted,sim_FD = NA,fleetDynamics = FALSE,type = "yield",yieldObs_timeVariant,ssbObs,rescale=3,areaEco)$plotYield_sp

# initial_effort*df_target = relative_effort as they both determine catches by spp 
# colSums(df_target*initial_effort) # based on catch and effort data and used in FD
# relative_effort[212,] # Fmort from SA (or catches) and used in previous model

# values decrease a lot but they reflet cathcability - need to include in paper? 

# rescale df_target*initial_effort using catchability
# calculate catchability
div<-relative_effort[212,]/colSums(df_target*initial_effort)
# what to do with values >1 ? can these be transfered to other param - e.g. initial effort? 
# div[div>1]<-1 # JUST TRIAL to understand the recoveries

df_target_bmsy<-df_target
df_target_bmsy<-sweep(df_target_bmsy, 2, div, FUN = '*')
df_target_bmsy[,1]<-0 # mycto
# df_target_bmsy[,11]<-df_target_bmsy[,11]*0.8 # seriorela 

# colSums(df_target_bmsy*initial_effort)
# relative_effort[212,]
# colSums(df_target_bmsy)

```

#-----------------------------------------
# First model run
#----------------------------------------------

```{r}

# start with community in 2006 (sim_fitted) or community at equilibium (sim_calibrated)
initial_n = sim_fitted@n[212,,]
initial_n_pp = sim_fitted@n_pp[212,]
initial_n_bb = sim_fitted@n_bb[212,]

# fix recoveries by changing erepro - see reasoning in next section  
# high erepro and high contribution to increasing fleets' catch 
df_param2<-df_param
df_param2[6, "erepro"]<-0.0001 # centroberix # SH 
df_param2[7, "erepro"]<-0.15 # squalus # general (?)
df_param2[9, "erepro"]<-0.0005 # platy # SH
df_param2[10, "erepro"]<-0.00005 # zuus # DS
df_param2[3, "erepro"]<-0.0001 # squid - DS, SH and  US - but this is playing with food...
df_param2[12, "erepro"]<-0.0000001 # OR (although not high erepro) # DS  

# second round - they all recover as effort declines 
df_param2[13, "erepro"]<-0.00001 # macrurus for US
df_param2[14, "erepro"]<-0.000001 # serio p for US (silver)
df_param2[16, "erepro"]<-0.00001 # genipt for US
df_param2[15, "erepro"]<-0.00001 # rexea for US

df_param2[11, "erepro"]<-0.00001 # seio b (blue) - for SH and US but just to fix the species 

df_param2[8, "erepro"]<-0.0001 # to fix the spp 

# fix Bmsy - need to lower Bmsy so that platy and genypt are above 20 and below 40? not NECESSARY as 20 or 40 have the same effect on managemtn unless n20>5 
# df_param2[9, "Bmsy"]<-df_param2[9, "Bmsy"]*0.0001 # platy - should not be under management....
# df_param2[16, "Bmsy"]<-df_param2[16, "Bmsy"]*0.0001 # genypt

# fix catches distribution 
df_target_bmsy2<-df_target_bmsy
colSums(df_target_bmsy2*initial_effort)
relative_effort[212,]

# less catch in SH - might be better to remove these spp from the catches instead of dropping them into a fleet? 
df_target_bmsy2[3,"trachurus declivis"]<-(sum(df_target_bmsy2[c(1,3),"trachurus declivis"])/10)*1 # moved from SH to SED
df_target_bmsy2[1,"trachurus declivis"]<-((sum(df_target_bmsy2[c(1,3),"trachurus declivis"])/10)*9)*7 # increased until it reached relative effort values 
df_target_bmsy2[3,"nototodarus gouldi"]<-(sum(df_target_bmsy2[c(1,3),"nototodarus gouldi"])/10)
df_target_bmsy2[1,"nototodarus gouldi"]<-((sum(df_target_bmsy2[c(1,3),"nototodarus gouldi"])/10)*9)*18

# fixing SED nad Sh given cacth contribution plots 
# df_target_bmsy2[3,"nototodarus gouldi"]<-(sum(df_target_bmsy2[c(1,3),"nototodarus gouldi"])/10)
# df_target_bmsy2[1,"nototodarus gouldi"]<-((sum(df_target_bmsy2[c(1,3),"nototodarus gouldi"])/10)*7)*5 


# less in SH and US and fix seriorella b plot
df_target_bmsy2[c(3,4),"seriolella brama"]<-df_target_bmsy2[c(3,4),"seriolella brama"]*0.3

# increase platy effort in SSG to redirect catches - not working  
# df_target_bmsy2[5,"platycephalus richardsoni"]<-df_target_bmsy2[1,"platycephalus richardsoni"]*0.5
# increse in SH to fix species plot - still recovering
# df_target_bmsy2[3,"platycephalus richardsoni"]<-df_target_bmsy2[3,"platycephalus richardsoni"]*1.3
# colSums(df_target_bmsy2*initial_effort)

# less catch in US
# df_target_bmsy2[4,"macruronus novaezelandiae"]<-df_target_bmsy2[4,"macruronus novaezelandiae"]*0.9 # very sensitive to this!!!

# decrease Fmort for some spp to fix sp plots. 
df_target_bmsy2[3,"centroberyx affinis"]<-df_target_bmsy2[3,"centroberyx affinis"]*0.3
df_target_bmsy2[3,"seriolella punctata"]<-df_target_bmsy2[3,"seriolella punctata"]*0.3
df_target_bmsy2[4,"galeorhinus galeus"]<-df_target_bmsy2[4,"galeorhinus galeus"]*0.3

# decrease DS
# df_target_bmsy2[2,"hoplostethus atlanticus"]<-df_target_bmsy2[2,"hoplostethus atlanticus"]*0.8 # already very low... and very senitive!!!

# more catch in SED - not doing much 
initial_effort2<-initial_effort
# initial_effort2[1]<-initial_effort2[1]*1.2
# initial_effort2[2]<-initial_effort2[2]*0.8 # very sensitive as above!!!

# ke ininfluential when managemetn kicks in ... 

# SSG declining too much - changed managemtn, where effort now decreases in proportion to the declining spp contribution to the community and the catch 

#### run model ---

params_FD <- MizerParams(df_param2, interaction = theta, kappa = kappa, kappa_ben = kappa_ben, kappa_alg = kappa_alg, w_pp_cutoff = w_pp_cutoff, min_w_bb = min_w_bb, w_bb_cutoff = w_bb_cutoff, fleetDynamics = TRUE, selectivity_params = df_selParam_new, catchability = df_target_bmsy2, target = df_target_bmsy2)

sim_FD_bmsy <- project(params_FD, effort = 0, dt = dt, fleetDynamics = TRUE, multiFleet = FALSE, management = TRUE, price = df_price_new, cost = df_cost3, diet_steps = 0, ke = ke_fleet, initial_n = initial_n, initial_n_pp = initial_n_pp, initial_n_bb = initial_n_bb, initial_effort = initial_effort2, scaling_price = scaling_price, Blevel_management = "Bmsy") 
plot_CN(sim_FD_bmsy)
df_target_bmsy2
sim_FD_bmsy@BioOut[[4]]

# plotBiomass(sim_FD_bmsy)$plot+facet_wrap(~Species)

# fast compare catches 
datValidationYield<-ungroup(datValidationYield)
datValidationEffort<-ungroup(datValidationEffort)

compareTrends(sim_fitted,sim_FD = sim_FD_bmsy, fleetDynamics = TRUE,type = "yield",yieldObs_timeVariant,ssbObs,rescale=3,areaEco)$plotYield_sp
compareTrends(sim_fitted,sim_FD = sim_FD_bmsy, fleetDynamics = TRUE,type = "yield",yieldObs_timeVariant,ssbObs,rescale=0,areaEco)$plotYield_fl
compareTrends(sim_fitted,sim_FD = sim_FD_bmsy, fleetDynamics = TRUE,type = "yield",yieldObs_timeVariant,ssbObs,rescale=0,areaEco)$plotEffort_fl

# check managemtn and declines in effort: 

# 1 - no changes to Bmsy - 4 spp below 20 is OK, we do not have collapses - we start the simulations with 4 adn end up with 2 due to recoveries 
# [1] genypterus blacodes       platycephalus richardsoni rexea solandri           
# [4] seriolella brama     
# warning = effort SET decreases less because platy is less depleted 

# 2 - lower Bmsy for platy - 4 spp below 20 is OK 
# [1] genypterus blacodes      nemadactylus macropterus rexea solandri          
# [4] seriolella brama   

# 2 - lower Bmsy for platy and genypt - 3 spp below 20 and it is still OK
# [1] nemadactylus macropterus rexea solandri           seriolella brama

# pr<-sim_FD_bmsy@BioOut[[20]] %>% 
#   filter(bioLim == "bio20check", fleet == "SED")
# unique(pr$species)
# 
# a<-lapply(sim_FD_bmsy@BioOut, function(x) x[which(x$fleet == "SED" & x$bioLim == "bio20check"),])
# b<-lapply(a, function(x) nrow(x))
# b


####### forward price and costs - same as in scenario but handy here for checking
# cannot run if you don't have the scenario matrices 

t_max = 13 # till 2030? if you run it for too long it's going to collaps... 
price_forward = t(replicate(t_max, df_price_new[nrow(df_price_new),]))
rownames(price_forward)<-seq(2018,(2018+t_max-1))
# price_trialscenario<-rbind(df_price_new, price_forward)

cost_forward1 <- t(replicate(t_max, df_cost3[nrow(df_cost3),,1]))
rownames(cost_forward1)<-seq(2018,(2018+t_max-1))
# cost_forward1<-rbind(df_cost3[,,1], cost_forward1)

cost_forward2 <- t(replicate(t_max, df_cost3[nrow(df_cost3),,2]))
rownames(cost_forward2)<-seq(2018,(2018+t_max-1))
# cost_forward2<-rbind(df_cost3[,,2], cost_forward2)
cost_forward <-array(c(cost_forward1,cost_forward2), dim = c(t_max,dim(cost)[2],dim(cost)[3]))

# cost_trialscenario <-array(c(cost_forward1,cost_forward2),dim = c(dim(cost_forward1)[1],dim(df_cost3)[2],dim(df_cost3)[3]), dimnames = c(dimnames(cost_forward1)[1],dimnames(df_cost3)[2],dimnames(df_cost3)[3]))

trial_params_FD <- MizerParams(df_param2, interaction = theta, kappa = kappa, kappa_ben = kappa_ben, kappa_alg = kappa_alg, w_pp_cutoff = w_pp_cutoff, min_w_bb = min_w_bb, w_bb_cutoff = w_bb_cutoff, fleetDynamics = TRUE, selectivity_params = df_selParam_new, catchability = df_target_MoreUnderQuota, target = df_target_MoreUnderQuota)

trial_scenarios <- project(trial_params_FD, effort = 0, dt = dt, fleetDynamics = TRUE, multiFleet = FALSE, management = TRUE, price = price_forward, cost = cost_forward, diet_steps = 0, ke = ke_fleet, initial_n = initial_n, initial_n_pp = initial_n_pp, initial_n_bb = initial_n_bb, initial_effort = initial_effort2, scaling_price = scaling_price, Blevel_management = "Bmsy") 

plotFleet(trial_scenarios)
pr<-trial_scenarios@BioOut[[4]] %>% 
  filter(bioLim == "bio20check", fleet == "SED")
unique(pr$species)

# spp below 20
# [1] macruronus novaezelandiae nemadactylus macropterus  pristiophorus cirratus   
# [4] rexea solandri            seriolella brama

a<-lapply(trial_scenarios@BioOut, function(x) x[which(x$fleet == "SED" & x$bioLim == "bio20check"),])
b<-lapply(a, function(x) nrow(x))
b

# t = 1 (BioOut = 0; 2018): effort = initial effort; Blim < 5
# t = 2 (BioOut = 4; 2019), effort = initial effort - changes; Blim > 5 (with consequence on effort next t)
# t = 3 (BioOut = 8; 2020), effort = 0
# trial_scenarios@effortOut

#### end checking 

# notes and checks 
# if using Bref: 
# genipterus, platy and serior b below 20 - only seriorelle is below 20 in reality 
# galoe below 40 
# none else below 48

# if using Bmsy : 
# platy, genypt, serior b (overfished) rexea (overfished) below 20
# centrob (overfished), galeo (overfished), macrurus, must, nemad, pristo, serio p, zeus below 40 
# OR (not overfished but below 40 for sure) below 48

# problems: 
# squalus (uncertain but likely overfished)

# depleted or under management in 2006? 
pr<-sim_FD_bmsy@BioOut[[4]] %>% 
  filter(bioLim == "bio20check")
unique(pr$species)

# catch composition by fleet
fleetn = 5
yield<-rowSums(aperm(sim_FD_bmsy@yield,c(1,2,4,3)),dims=3)
sort(-df_target_bmsy[fleetn,])

# cacth composition through time SEE PLOTS BELOW
trial<-yield[,,fleetn]
trial<-as.data.frame(trial) %>% 
  mutate(time = as.numeric(rownames(trial))) %>% 
  gather(species, yield, -time) %>% 
  filter(yield>0)

ggplot(trial, aes(x = time, y = yield, fill = species)) +
    geom_bar(position = "stack", stat = "identity") +
    scale_y_continuous()

main<-trial[which(trial$time == 2007),]
main[order(-main$yield),]

pr<-sim_FD_bmsy@BioOut[[4]] %>% 
  filter(bioLim == "bio40check", fleet =="SSG")
unique(pr$species)

# Economy 
# compare profit and effort (to figure out ke)
sim_FD_bmsy@effortOut*areaEco/scaling_cost_area # operations in SESSF 
sim_FD_bmsy@profit*areaEco #/scaling_cost_area # $ in SESSF

yield<-rowSums(aperm(sim_FD_bmsy@yield,c(1,2,4,3)),dims=3) # sum over size
yield<-rowSums(aperm(yield,c(1,2,3)),dims=2) # sum over fleets
(yield/1000000)*areaEco

yield2<-rowSums(aperm(sim_FD_bmsy@yield,c(1,2,4,3)),dims=3) # sum over size
yield2<-rowSums(aperm(yield2,c(1,3,2)),dims=2) # sum over fleets
(yield2/1000000)*areaEco

bio<-getBiomass(sim_FD_bmsy)
(bio/1000000)*areaEco

# raw values 
sim_FD_bmsy@effortOut
yield2
sim_FD_bmsy@profit

# # compared with other communities
# plot(sim_calibrated)
# plot(sim_fitted)
# plot_CN(sim_FD_bmsy)
# plotFleet(sim_FD_bmsy)
# 
# # diet
# dim(sim_FD_bmsy@diet_comp) # predator X size X prey X prey size
# plotDietComp(sim_FD_bmsy)$p
# image(sim_FD_bmsy@diet_comp[19,,9,])
# 
# # growth
# df_param[,c(1,5,8)]
# df_param$max_age<-c(4,7,10,40,25,44,30,40,12,18,22,100,25,23,16,30,15,16,55)
# spp = as.character(df_param[19,1])
# max_age = df_param[19,"max_age"]
# plotGrowthCurves(sim_FD_bmsy, species = spp, max_age = max_age)

```

#-----------------------------------------
# recoveries *can skip*
#----------------------------------------------

this was initially done with erepro as per def (df_param) and  target matrix as per def or similar (df_target_bmsy) then used the version '2' to check results  

```{r}

# using pre recovery-fix model (calibrated cost scalar and ke, managemtn = TRUE): 
# which fleet shows higher catches at decrease effort due to recoveries? 
yield<-rowSums(aperm(sim_FD_bmsy@yield,c(1,2,4,3)),dims=3)
sort(-((rowSums(aperm(yield,c(3,2,1)),dims=2)/1000000)*areaEco)[2,]) # DS
sort(-((rowSums(aperm(yield,c(3,2,1)),dims=2)/1000000)*areaEco)[3,]) # SH
sort(-((rowSums(aperm(yield,c(3,2,1)),dims=2)/1000000)*areaEco)[4,]) # US
plotBiomass(sim_FD_bmsy)$plot +facet_wrap(~Species)

# plot yeld vs effort by spp 
yield_sp<-rowSums(aperm(yield,c(1,2,3)),dims=2) # sum over fleets
yield_sp<-as.data.frame(yield_sp) %>% 
  mutate(time = rownames(yield_sp)) %>% 
  gather(species, yield, -time)

effort_sp<-as.data.frame(sim_FD_bmsy@effortOut) %>% 
  mutate(time = rownames(sim_FD_bmsy@effortOut)) %>% 
  gather(fleet, effort, -time)
effort_sp_q<-as.data.frame(df_target_bmsy) %>% 
  mutate(fleet = rownames(df_target_bmsy)) %>% 
  gather(species, q, -fleet) 

all1<-effort_sp_q %>% 
  left_join(effort_sp) %>% 
  mutate(effort = effort*q) %>% 
  select(-c(q)) %>% 
  group_by(species, time) %>% 
  dplyr::summarise(effort = sum(effort))
all2<-all1 %>% 
  left_join(yield_sp) %>% 
  select(-c(time)) %>% 
  filter(species != "myctophids")

# plot: strange trends due to a combination of dynamics. A confusing one is that effort decreases in time (here effort increases) while abundance increases. I tried 1 sp and main fleet at the time; I get the same output so the methods is OK.
ggplot(all2, aes(x = effort, y = yield))+
  geom_point()+
  geom_line()+
  facet_wrap(~species, scales = "free")

# to make this plot meaningful you need to simplify dynamics: 
# 1 effort increases in time - i.e. no management 
# 2 all spp are targeted by 1 fleet (SH) with q=1 for better comparisons 
# 3 ke is lowered otherwise effort changes too fast and become too high at the  end of the run.  

trail_q<-df_target_bmsy2
trail_q[3,]<-1
trail_q[c(1,2,4,5),]<-0

# try df_param foirs as the one with no erepro modified

trial <- MizerParams(df_param2, interaction = theta, kappa = kappa, kappa_ben = kappa_ben, kappa_alg = kappa_alg, w_pp_cutoff = w_pp_cutoff, min_w_bb = min_w_bb, w_bb_cutoff = w_bb_cutoff, fleetDynamics = TRUE, selectivity_params = df_selParam_new, catchability = trail_q, target = trail_q)

sim_trial <- project(trial, effort = 0, dt = dt, fleetDynamics = TRUE, multiFleet = FALSE, management = FALSE, price = df_price_new, cost = df_cost3, diet_steps = 0, ke = data.frame(fleet= rownames(df_target), ke = rep(100000, 5)) , initial_n = initial_n, initial_n_pp = initial_n_pp, initial_n_bb = initial_n_bb, initial_effort = initial_effort2, scaling_price = scaling_price, Blevel_management = "Bmsy")

# plot yeld vs effort by spp 
yield<-rowSums(aperm(sim_trial@yield,c(1,2,4,3)),dims=3)
yield_sp<-rowSums(aperm(yield,c(1,2,3)),dims=2) # sum over fleets

yield_sp<-as.data.frame(yield_sp) %>% 
  mutate(time = rownames(yield_sp)) %>% 
  gather(species, yield, -time)
effort_sp<-as.data.frame(sim_trial@effortOut) %>% 
  mutate(time = rownames(sim_trial@effortOut)) %>% 
  gather(fleet, effort, -time) %>% 
  filter(fleet == "SET-SH") %>% 
  select(-fleet)
all2<- effort_sp %>% 
  left_join(yield_sp) %>% 
  select(-c(time)) %>% 
  filter(species != "myctophids")

erep<-ggplot(all2, aes(x = effort, y = yield))+
  geom_point()+
  geom_line()+
  facet_wrap(~species, scales = "free")

# plot_CN(sim_trial)
# plotFleet(sim_trial)

#### FIG S2 
# to do : lots change colors and do point for modelled
setwd("/Users/nov017/Dropbox/Mizer-fleet_extension/plot/FD/Final")
tiff("FigS2B_May2020.tiff", height=6, width=10, units ='in', res=300)
erep
dev.off()

# high erepro (but depends on the changed param above - so used higher ke): 
# centroberix - fix
# helicolenus - still high after fix 
# macrurus - still high after fix
# nemadactylus - still high after fix  
# squid - fix
# platy - fixed!
# sillago - fix 
# squalus - fixed 
# tracurus - still high after fix
# zeus - still high  after fix

# increased abundance - of these spp, which recover between 2007 and 2017? 
a<-plotBiomass(sim_trial)$BioData
ggplot(a, aes(x = time, y = value))+
  geom_point()+
  geom_line()+
  facet_wrap(~Species, scales = "free")

# centroberix - si
# helicolenus - si but food
# macrurus - si 
# nemadactylus - si 
# squid - no but food
# platy - si
# sillago - no  
# squalus  - si
# tracurus - si but food
# zeus - si

# and if using the real model - all but the 'food' 
b<-plotBiomass(sim_FD_bmsy)$BioData
ggplot(b, aes(x = time, y = value))+
  geom_point()+
  geom_line()+
  facet_wrap(~Species, scales = "free")

# if using the real model- which spp recover most? 
plotBiomass(sim_FD_bmsy)$plot + facet_wrap(~Species)

# centrob (?)
# squalus 
# platy 
# zeus 

# which contribute to the increasing catch  of fleets
yield<-rowSums(aperm(sim_FD_bmsy@yield,c(1,2,4,3)),dims=3)
sort(-((rowSums(aperm(yield,c(3,2,1)),dims=2)/1000000)*areaEco)[2,]) # DS
sort(-((rowSums(aperm(yield,c(3,2,1)),dims=2)/1000000)*areaEco)[3,]) # SH
sort(-((rowSums(aperm(yield,c(3,2,1)),dims=2)/1000000)*areaEco)[4,]) # US

# zeus - DS 
# platy - SH
# centrob - SH

# squalus - because increasing too fast 

# also: 
# macrurus - DS 
# OR - DS (although not high erepro)  

# nemadact - SH 
# seriorella B (although not high erepro)

```

#-----------------------------------------
# save data
#----------------------------------------------

```{r}

# save.image(file = "/Users/nov017/Dropbox/Mizer-fleet_extension/data/FDData_opn3.RData") # was FDData_Nov2.RData or FDData_Nov.RData if using SEAmodel_opn2.RData as input and Tune Q opn2 

save.image(file = "/Users/nov017/Dropbox/Mizer-fleet_extension/data/FDData_opn3_May_noerepro.RData") # was FDData_Nov2.RData or FDData_Nov.RData if using SEAmodel_opn2.RData as input and Tune Q opn2, noerepro if erepro has not been changed


```

#-----------------------------------------
# plot - catch by species and fleet *move to DataFunction?*
#---------------------------------------------- 

```{r}

catchComp<-function(sim_FD_bmsy, df_log_spp){

  # mearge fig 5 and 4 
  
  # modelled catch by species AND fleet
  trial<-compareTrends(sim_fitted,sim_FD_bmsy,fleetDynamics = TRUE,type = "yield",yieldObs_timeVariant,ssbObs,rescale=0,areaEco)$trial
  trial<-as.data.frame.table(trial, responseName = "yield")
  colnames(trial)<-c("year", "species","fleet", "yield_tonnes")

  # observed catch by species and fleet. This is as per code in SEA_FleetParam.Rmd line 1647 to calculate datValidationYieldSpp which theh bocame yieldObs_timeVariant in createFmort() in DataFunction.r - thus follwong same protocoll as per all observed data for validation 
  datValidationYieldSppFl<-df_log_spp %>%
    filter(metier %in% df_main_metier, SPC_NAME %in% df_param$species) %>% 
    group_by(SPC_NAME, metier, YEAR) %>% 
    dplyr::summarise(catchComm = sum(TOT_CATCH_KG, na.rm=TRUE)/1e3) %>% 
    `colnames<-`(c("species","fleet","year","yield_tonnes")) %>% 
    mutate(fleet = case_when(fleet == "GHAT - Southern Shark Gillnet" ~ "SSG",
                           fleet == "South East Trawl Fishery - Danish Seine" ~ "SED",
                           fleet == "South East Trawl Fishery - Otter trawl deepSlope" ~ "SET-DS",
                           fleet == "South East Trawl Fishery - Otter trawl shelf" ~ "SET-SH",
                           fleet == "South East Trawl Fishery - Otter trawl upperSlope" ~ "SET-US")) 

  # modelled and observed together
  # NOTE: you added catches and calcualted Fmort according to these catches for trachurus. Here they are missing but Q=1 for tracurus and these fleets.  
  datValidationYieldSppFl$color<-"observed"
  trial$color <- "modelled_FD"
  trial$year<-as.numeric(as.character(trial$year))
  trial$species<-as.character(trial$species)
  trial$fleet<-as.character(trial$fleet)
  yieldData_sp_fl<-merge(trial,datValidationYieldSppFl, all =TRUE ) 
  yieldData_sp_fl<-yieldData_sp_fl%>% 
    filter(year >= 2006) %>% 
    left_join(df_param[,c(1,2)])

  yieldData_sp_fl %>% 
    filter(yield_tonnes>50, fleet =="SSG", year == 2006) %>% 
    arrange(-yield_tonnes)

# plot modelled vs observed
  
  # choose color
  library(RColorBrewer)
  colourCount = length(unique(yieldData_sp_fl$spCommon))
  getPalette = colorRampPalette(brewer.pal(12, "Set2"))
  
  # order factors 
  a = c("SET-SH","SET-US","SSG","SET-DS","SED")
  b = c("modelled_FD", "observed")
  c = df_param[,2]
  yieldData_sp_fl<-yieldData_sp_fl %>% 
    mutate(fleet = factor(fleet, level = a)) %>% 
    mutate(color = factor(color, level = b)) %>% 
    # mutate(yaer = factor(year)) %>%
    mutate(spCommon = factor(spCommon, level = c)) %>% 
    mutate(color = ifelse(color == "modelled_FD", "Modelled", "Observed")) %>% 
    filter(spCommon != "lanternfish")

  # install.packages("Hmisc")
  # library(Hmisc)
  # yieldData_sp_fl$spCommon<- capitalize(as.character(yieldData_sp_fl$spCommon))
  # yieldData_sp_fl$spCommon<-as.factor(yieldData_sp_fl$spCommon)
  
  scaleFUN <- function(x) sprintf("%.0f", x)
  spNames<-c("Whiting","Squid","Perch","Mackerel","Redfish","Deep shark","Morwong","Flathead","Dories","Blue warehou","Orange roughy","Blue granadier","Silver warehou","Gemfish","Pink ling","Sawshark","Gummy shark","School shark")
  
  unique(yieldData_sp_fl$year)
  
  p <- ggplot(yieldData_sp_fl, aes(x=year, y = yield_tonnes, fill=spCommon)) + 
    geom_bar(position = "stack", stat = "identity") +
    scale_fill_manual(values=getPalette(colourCount), name= "Species", labels = spNames)+
    facet_grid(color~fleet)+ # scale ="free"
    scale_y_continuous(name = "Yield [tonnes]") +
    scale_x_continuous(labels = scaleFUN, name = "Year") +
    # scale_x_continuous(name = "Year", labels = scales::number_format(accuracy = 1))+
    theme_bw()+
    theme(text = element_text(size=14),
          axis.title.y = element_text(vjust=0.4, size = 15),
          axis.title.x = element_text(vjust=0.3, size = 15),
          axis.text.y = element_text(size=10, hjust=0.5),
          axis.text.x = element_text(size=10, angle = 90, hjust=0.5),
          panel.grid.major = element_blank(),
          strip.background = element_blank(),
          panel.border = element_rect(colour = "black"),
          strip.text.x = element_text(face = "bold"),
          # legend.title = element_text(size = 5),
          # legend.text = element_text(size = 5)) 
          legend.key.size = unit(0.3, "cm"))
  
  return(p = p)
}

fig3b<-catchComp(sim_FD_bmsy, df_log_spp)

#### FIG S5 # this is now combined with  Fig 4 - see below 
# to do : change color and deside on bar plot or lines 
# setwd("/Users/nov017/Dropbox/Mizer-fleet_extension/plot/FD/Final")
# tiff("Fig5_May2020.tiff", height=8, width=9, units ='in', res=300)
# catchComp(sim_FD_bmsy, df_log_spp)
# dev.off()

```

#-----------------------------------------
# plot - catch and effort by species or fleet
#---------------------------------------------- 

```{r}

plotBio_sp<-plotBiomass_CN(sim_fitted,sim_FD_bmsy, df_param, rescale = 0)$p 
BioData<-plotBiomass_CN(sim_fitted,sim_FD_bmsy, df_param, rescale = 0)$BioData
colnames(BioData)<-c("year", "species","bio_tonnes","type","common")

prova<-BioData %>% 
  select(-species) %>% 
  filter(type == "modelled_FD") %>% 
  group_by(common, type) %>% 
  dplyr::summarise(value = mean(bio_tonnes))
as.data.frame(prova[order(-prova$value),])

plotSSB_sp<-compareTrends(sim_fitted,sim_FD = sim_FD_bmsy, fleetDynamics = TRUE,type = "SSB",yieldObs_timeVariant,ssbObs,rescale=0,areaEco)$plotYield_sp 
SSBData<-compareTrends(sim_fitted,sim_FD = sim_FD_bmsy, fleetDynamics = TRUE,type = "SSB",yieldObs_timeVariant,ssbObs,rescale=0,areaEco)$DataPlotYield
colnames(SSBData)<-c("year", "species","ssb_tonnes","type","common")

plotYield_sp_rescaled<-compareTrends(sim_fitted,sim_FD = sim_FD_bmsy, fleetDynamics = TRUE,type = "yield",yieldObs_timeVariant,ssbObs,rescale=3,areaEco)$plotYield_sp 
plotYield_sp_rescaled2<-compareTrends(sim_fitted,sim_FD = NA, fleetDynamics = FALSE,type = "yield",yieldObs_timeVariant,ssbObs,rescale=3,areaEco)$plotYield_sp 

# whcih colors are used in this plots? 
ggplot_build(plotYield_sp_rescaled)$data
# change colurs accordingly 
plotYield_sp_rescaled2<- plotYield_sp_rescaled2+
  scale_color_manual(values=c("#440154FF", "#21908CFF"))

plotYield_sp_raw<-compareTrends(sim_fitted,sim_FD = sim_FD_bmsy, fleetDynamics = TRUE,type = "yield",yieldObs_timeVariant,ssbObs,rescale=0,areaEco)$plotYield_sp 
yieldData<-compareTrends(sim_fitted,sim_FD = sim_FD_bmsy, fleetDynamics = TRUE,type = "yield",yieldObs_timeVariant,ssbObs,rescale=0,areaEco)$DataPlotYield
colnames(yieldData)<-c("year", "species","yield_tonnes","type","common")

yieldData_spp_fleet<-yieldData_sp_fl # being added to the outputs 

plotYield_fl<-compareTrends(sim_fitted,sim_FD = sim_FD_bmsy, fleetDynamics = TRUE,type = "yield",yieldObs_timeVariant,ssbObs,rescale=0,areaEco)$plotYield_fl
yieldData_fleet<-compareTrends(sim_fitted,sim_FD = sim_FD_bmsy, fleetDynamics = TRUE,type = "yield",yieldObs_timeVariant,ssbObs,rescale=0,areaEco)$DataPlotYield_fl 
colnames(yieldData_fleet)<-c("year", "fleet","yield_tonnes","type")

plotEffort_fl<-compareTrends(sim_fitted,sim_FD = sim_FD_bmsy, fleetDynamics = TRUE,type = "yield",yieldObs_timeVariant,ssbObs,rescale=0,areaEco)$plotEffort_fl
effortData<-compareTrends(sim_fitted,sim_FD = sim_FD_bmsy, fleetDynamics = TRUE,type = "yield",yieldObs_timeVariant,ssbObs,rescale=0,areaEco)$DataPlotEffort_fl 
colnames(effortData)<-c("year", "fleet","effort_opn","type")

# Plot effort and catch by fleet together
a<-effortData
b<-yieldData_fleet

colnames(a)<-c("year", "fleet", "EFFORT", "color")
colnames(b)<-c("year", "fleet", "YIELD", "color")
temp<-merge(a, b, all = TRUE)
temp<-temp %>% 
  gather("type", "value", -c(year, fleet, color))

scaleFUN <- function(x) sprintf("%.0f", x)

plotEffortCatch_fl <- ggplot(temp, aes(x=year, y = value, colour=color)) + 
  geom_line(aes(x=year, y = value, colour=color), size=1) +    
  scale_x_continuous(labels = scaleFUN, name = "Year") +
  theme_bw() +
  theme(legend.title = element_blank(),
        text = element_text(size=12),
        legend.text=element_text(size=12),
        axis.title.y = element_text(size=12, vjust=0.4),
        axis.title.x = element_text(size=12, vjust=0.3),
        axis.text.y = element_text(size=10, hjust=0.5),
        axis.text.x = element_text(size=10, angle = 90, hjust=0.5),
        panel.grid.major = element_blank(),
        strip.background = element_rect(colour="black", fill= NA)) +
  scale_y_continuous(name = "tonnes                    operations")+
  facet_grid(vars(type), vars(fleet), scales="free_y")

# dots and line version 
head(temp2)
a = c("SET-SH","SET-US","SSG","SET-DS","SED")
temp2<-temp %>% 
  spread(color, value) %>% 
  filter(type == "EFFORT") %>% 
  mutate(fleet = factor(fleet, level = a)) 

plotEffortCatch_fl <- ggplot(temp2) + 
  geom_line(aes(x=year, y= modelled_FD), size=0.5) +
  geom_point(aes(x=year, y = observed), size = 1, shape = 1)+
  scale_x_continuous(labels = scaleFUN, name = "Year") +
  theme_bw() +
  theme(text = element_text(size=14),
        axis.title.y = element_text(vjust=0.4, size = 15),
        axis.title.x = element_text(vjust=0.3, size = 15),
        axis.text.y = element_text(size=10, hjust=0.5),
        axis.text.x = element_text(size=10, angle = 90, hjust=0.5),
        panel.grid.major = element_blank(),
        strip.background = element_blank(),
        panel.border = element_rect(colour = "black"),
        strip.text.x = element_text(face = "bold"))+
  scale_y_continuous(name = "Effort [opn]")+
  facet_wrap(~fleet, nrow = 1)

plotEffortCatch_fl


```

#-----------------------------------------
# save plots and csv
#----------------------------------------------

```{r}

library(patchwork)

# # plots
# setwd("/Users/nov017/dataXBeth/SEA_sizespectrum_outputs") # need to change directory.... 
# 
# tiff("plotSSB_sp.tiff", height=6, width=9, units ='in', res=300)
# plotSSB_sp 
# dev.off()
# 
# tiff("plotYield_sp_rescaled_FLT.tiff", height=6, width=9, units ='in', res=300)
# plotYield_sp_rescaled
# dev.off()
# 
# tiff("plotYield_sp_rescaled_no_FD.tiff", height=6, width=9, units ='in', res=300)
# plotYield_sp_rescaled2
# dev.off()
# 
# tiff("plotYield_sp_raw_FLT.tiff", height=6, width=9, units ='in', res=300)
# plotYield_sp_raw
# dev.off()
# 
# tiff("catch_Comp.tiff", height=8, width=9, units ='in', res=300)
# p
# dev.off()
# 
# tiff("plotYield_fl.tiff", height=4, width=9, units ='in', res=300)
# plotYield_fl
# dev.off()
# 
# tiff("plotEffort_fl.tiff", height=4, width=9, units ='in', res=300)
# plotEffort_fl
# dev.off()

# #### FIG 4 - now merged to fig 5
# # to do : change colors and do point for modelled change legend
# setwd("/Users/nov017/Dropbox/Mizer-fleet_extension/plot/FD/Final")
# tiff("Fig4_May2020.tiff", height=4, width=8, units ='in', res=300)
# plotEffortCatch_fl
# dev.off()

###### FIG 3
#install.packages("ggpubr")
library(cowplot)
library(ggpubr)
leg<-get_legend(fig3b)
leg<-as_ggplot(leg)
#leg<-leg+theme(text = element_text(size=2))
fig3b2<-fig3b + theme(legend.position = "none")

# setwd("/Users/nov017/Dropbox/Mizer-fleet_extension/plot/FD/Final")
# tiff("Fig3_Sept2020.tiff", height=6, width=8, units ='in', res=300)
# ((plotEffortCatch_fl/fig3b2 + plot_layout(nrow=2,height=c(1,2))) | (plot_spacer()/leg + plot_layout(nrow=2,height=c(2,2)))) + plot_layout(ncol=2, widths = c(4,1))
# dev.off()

setwd("/Users/nov017/Dropbox/Mizer-fleet_extension/plot/FD/Final")
# pdf("Fig3_Sept2020.pdf", height=6, width=8)
pdf("Fig3_noerepro.pdf", height=6, width=8)
((plotEffortCatch_fl/fig3b2 + plot_layout(nrow=2,height=c(1,2))) | (plot_spacer()/leg + plot_layout(nrow=2,height=c(2,2)))) + plot_layout(ncol=2, widths = c(4,1))
dev.off()

# tiff("/Users/nov017/Desktop/plot_fleet.tiff", height=4, width=9, units ='in', res=300)
# plotEffortCatch_fl
# dev.off()

# # csv data
# write.csv(BioData, "BioData.csv",row.names=FALSE)
# write.csv(SSBData, "SSBData.csv", row.names=FALSE)
# write.csv(yieldData, "yieldData.csv", row.names=FALSE)
# write.csv(yieldData_spp_fleet, "yieldData_spp_fleet.csv", row.names=FALSE)
# write.csv(yieldData_fleet, "yieldData_fleet.csv", row.names=FALSE)
# write.csv(effortData, "effortData.csv", row.names=FALSE)

```

#-----------------------------------------
# Shiny *Delete?*
#----------------------------------------------

```{r}

sim = sim_fitted
df_param = df_param
interaction = theta
kappa = kappa
kappa_ben = kappa_ben
kappa_alg = kappa_alg 
w_pp_cutoff = w_pp_cutoff 
min_w_bb = min_w_bb
w_bb_cutoff = w_bb_cutoff
fleetDynamics = TRUE
selectivity_params = df_selParam_new
catchability = df_target_bmsy
target = df_target_bmsy
effort = 0
dt = 0.5 
management = TRUE
price = df_price_new
cost = df_cost3
diet_steps = 0
ke = ke_fleet
initial_n = initial_n
initial_n_pp = initial_n_pp
initial_n_bb = initial_n_bb
initial_effort = initial_effort
scaling_price = scaling_price
Blevel_management = "Bmsy"

type = "yield"
rescale = 0

# source("/Users/nov017/Dropbox/Mizer-fleet/R/SEA_Shiny.R")
# fn_shiny_FD(df_param, theta, kappa, kappa_ben, kappa_alg, w_pp_cutoff, min_w_bb, w_bb_cutoff, fleetDynamics, selectivity_params, catchability, target, effort, dt, management, price, cost, diet_steps, ke, initial_n, initial_n_pp, initial_n_bb, initial_effort, scaling_price, Blevel_management, sim, type, yieldObs_timeVariant,ssbObs,rescale, areaEco)

# arrivata qui - something is wromng with Shiny as it does not reproduce the same trends when changing target values.... need to re-check adn re-run 

# to adjust 
# SSB option is different from fleetDynamics = TRUE and FALSE (when FALSE you ahev problems with fleet plots)
# rescaling options need to be rechecked for FD = TRUE
# add profitability values 

# to explore: 
# starting effort values for all fleets - in Shiny 
# ke for all fleets 
# Q for all species - in Shiny 
# management rule 

```

