---
title: "Scenario"
author: "Camilla Novaglio"
date: "05/11/2019"
output: html_document
---

#-----------------------------------------
# upload codes and data 
#----------------------------------------------

```{r}

rm(list=ls())

# load data 
# load("/Users/nov017/Dropbox/Mizer-fleet/R/model/FDData_Nov.RData") # FDData_opn3.RData or FDData_opn2.RData (was FDData_Nov.RData)
# new folder
load("/Users/nov017/Dropbox/Mizer-fleet_extension/data/FDData_opn3_May.RData") # this is too heavy - the below should be done in the previous script - not working 

# rm(list=setdiff(ls(), c(sim_FD_bmsy, df_param2, theta, kappa, kappa_ben, kappa_alg,w_pp_cutoff, min_w_bb, w_bb_cutoff, df_selParam_new, df_target_bmsy2, df_price_new, df_cost3, ke_fleet, scaling_price, initial_n, initial_n_bb, initial_n_pp, initial_effort2)))

library(plyr)
library(tidyverse)
library(reshape2)
library(ggplot2)
library(dplyr)
library(matrixStats)

setwd("/Users/nov017/R-projects/Mizer-fleet/R")
source("data.R") 
source("help.R") 
source("MizerParams-class.R") 
source("MizerSim-class.R")
source("plots.R")
source("project_methods.R")
source("project.R")
source("RcppExports.R") 
source("selectivity_funcs.R")
source("summary_methods.R")
source("wrapper_functions.R")
source("DataFunction.R") 

# not sure I should specify this here?
sim = sim_FD_bmsy
df_param = df_param2
interaction = theta
kappa = kappa
kappa_ben = kappa_ben
kappa_alg = kappa_alg
w_pp_cutoff = w_pp_cutoff
min_w_bb = min_w_bb
w_bb_cutoff = w_bb_cutoff
fleetDynamics = TRUE
selectivity_params = df_selParam_new
catchability = df_target_bmsy2
target = df_target_bmsy2
effort = 0
dt = 0.25
management = TRUE
price = df_price_new
cost = df_cost3
diet_steps = 0
ke = ke_fleet
scaling_price = scaling_price
Blevel_management = "Bmsy"
initial_n = initial_n
initial_n_pp = initial_n_pp
initial_n_bb = initial_n_bb
initial_effort = initial_effort2

```

#-----------------------------------------
# fleet strucutres and scenarios
#----------------------------------------------

```{r}

######## Run forward using 1) initial community as per last time step of time-variant sim and 2) price and costs as per last time step of time-variant sim. Change only interaction matrix as per scenarios. 

######## results circulated for comments: 
# t_max = 23
# df_param2<-df_param
# 4 years rule, initial effort after 4 years = 0.01

# run unitill MEY equilibrium 
# problem - fishing effort does not increase once it reaches 0 
# possible reasons: 
# 1) spp collapse because erepro is too low. Increase erepro to 10: DS reaches equilibrium but others dont's as spp keep decreasing. predator-prey mechanisms? 
# 2) fleets are not economic to run. run with no management: fishing effort increases for most fleets meaning that economy is not a problem. Upper sloe is always declining 

####### initial community
initial_n_scenario = sim@n[nrow(sim@n),,]
initial_n_pp_scenario  = sim@n_pp[nrow(sim@n_pp),]
initial_n_bb_scenario  = sim@n_bb[nrow(sim@n_bb),]
initial_effort_scenario = sim@effortOut[dim(sim@effortOut)[1],]   

####### forward price and costs
t_max = 23 # till 2030 (13) or 2040 (23)? till MEY (100 - collapses)?
# change the 4 years rule to 10 to let stock recovering
# start with a much smaller amount of effort? 
price_forward = t(replicate(t_max, price[nrow(price),]))
rownames(price_forward)<-seq(1:t_max) # or...
rownames(price_forward)<-seq(2018,(2018+t_max-1))

cost_forward1 <- t(replicate(t_max, cost[nrow(cost),,1]))
rownames(cost_forward1)<-seq(1:t_max) # or ... 
rownames(cost_forward1)<-seq(2018,(2018+t_max-1))

cost_forward2 <- t(replicate(t_max, cost[nrow(cost),,2]))
rownames(cost_forward2)<-seq(1:t_max) # or ...
rownames(cost_forward2)<-seq(2018,(2018+t_max-1))

cost_forward <-array(c(cost_forward1,cost_forward2), dim = c(t_max,dim(cost)[2],dim(cost)[3])) # or ...
cost_forward <-array(c(cost_forward1,cost_forward2),dim = c(dim(cost_forward1)[1],dim(cost)[2],dim(cost)[3]), dimnames = c(dimnames(cost_forward1)[1],dimnames(cost)[2],dimnames(cost)[3]))

####### TRIAL change erepro back to original values to check for collapses? 
df_param2<-df_param
# just  to stop collapsing 
# df_param2$erepro<-40
# df_param2[3, "erepro"]<-0.01 # squid back to before erepro calibration 
# df_param2[6, "erepro"]<-0.01 # centroberix # SH 
# # df_param2[7, "erepro"]<-0.05 # squalus # general (?)
# df_param2[9, "erepro"]<-0.01 # platy # SH
# df_param2[10, "erepro"]<-0.01 # zuus # DS
# df_param2[3, "erepro"]<-0.01 # squid - DS, SH and  US - but this is playing with food...
# df_param2[12, "erepro"]<-0.01 # OR (although not high erepro) # DS  
# df_param2[13, "erepro"]<-0.01 # macrurus for US
# df_param2[14, "erepro"]<-0.01 # serio p for US (silver)
# df_param2[16, "erepro"]<-0.01 # genipt for US
# df_param2[15, "erepro"]<-0.01 # rexea for US
# df_param2[11, "erepro"]<-0.01 # seio b (blue) - for SH and US but just to fix the species 
# df_param2[8, "erepro"]<-0.01 # t



####### interaction matrix options

######## note - be carefull with these values, does this mean that exploitation rate is higher than 1? the values below act as catchability only, but if you add all the Fmort from all the fleets? check that exploitation rate (catch/biomass at t) is lower than 1 

# colSums(df_target_bmsy2*initial_effort2)
# 
# # or model output... 
# 
# a<-getBiomass(sim)
# b<-sim@yield
# b<-rowSums(aperm(b,c(1,2,4,3)),dims=3) # sum over size
# b<-rowSums(b,dims=2)
# c<-b/a
# c[c>0.2] # exploitation rate for all spp is less than 20%

######## trial model to understand things - status quo (initial community and fleets as per sim_FD_bmsy)

params_trial <- MizerParams(df_param2, interaction = theta, kappa = kappa, kappa_ben = kappa_ben, kappa_alg = kappa_alg, w_pp_cutoff = w_pp_cutoff, min_w_bb = min_w_bb, w_bb_cutoff = w_bb_cutoff, fleetDynamics=TRUE, selectivity_params = selectivity_params, catchability = catchability, target = target)

sim_trial <- project(params_trial, effort = 0, dt = dt, fleetDynamics = TRUE, management = TRUE, multiFleet = FALSE, price = price_forward, cost = cost_forward, diet_steps = 0, ke = ke, initial_effort = initial_effort_scenario, scaling_price = scaling_price, Blevel_management = Blevel_management, initial_n = initial_n_scenario, initial_n_pp = initial_n_pp_scenario , initial_n_bb = initial_n_bb_scenario)

plotFleet(sim_trial)
sim_trial@effortOut

length(sim_trial@BioOut) # 100*4
# but lots of NULLs
sim_trial@BioOut[[390]] %>% # year ~75
  filter(bioLim == "bio20check", fleet == "SED")

# do species recover? no squid collapses - see line 510 in other file  
plotBiomass(sim_trial)$plot + facet_wrap(~Species)

# plot_CN(sim)
# plotFleet(sim)




# # try understand 
# # 1 why effort = 0 even if less than 5 spp are below 20? becasue 0s are due to platy being below 40 and the main catch, also some decreases are due to profits; all good  
# # 2 why effort = 0 for less than 4 years before becoming 0.01... OK WHEN RUNNING INSIDE PROJECT!! this should be fixed now - sometimes it jumps the 0.01 and go to either a close number (0.009 if effort is formced to decrease) or to 0 again (if effort is forced to stop). this happens when the 0.01 time step is not saved - CHECKED 
# 
# params_trial <- MizerParams(df_param2, interaction = theta, kappa = kappa, kappa_ben = kappa_ben, kappa_alg = kappa_alg, w_pp_cutoff = w_pp_cutoff, min_w_bb = min_w_bb, w_bb_cutoff = w_bb_cutoff, fleetDynamics=TRUE, selectivity_params = selectivity_params, catchability = df_target_NoCompetition, target = df_target_NoCompetition)
# 
# sim_trial <- project(params_trial, effort = 0, dt = 0.25, fleetDynamics = TRUE, management = TRUE, multiFleet = FALSE, price = price_forward, cost = cost_forward, diet_steps = 0, ke = ke, initial_effort = initial_effort_scenario, scaling_price = scaling_price, Blevel_management = Blevel_management, initial_n = initial_n_scenario, initial_n_pp = initial_n_pp_scenario, initial_n_bb = initial_n_bb_scenario, initial_n_aa = params_trial@initial_n_aa,t_save = 1, t_max = 13,temperature = rep(params_trial@t_ref, times = t_max),shiny_progress = NULL)
# 
# plotFleet(sim_trial)
# # sim_trial@effortOut
# # sim_trial@effortOut_dt


####### should recovery speceis not being caought in any of these scenario?! using recent data does not change the target matrix as it details how much of the whatever catch is split into teh main fleet, but may change the list of main fleet - i.f. deep slope may be togethr with eth upper slope 

######## target unfished 
df_target_unfished<-target
df_target_unfished[]<-0

# params_unfished <- MizerParams(df_param, interaction = theta, kappa = kappa, kappa_ben = kappa_ben, kappa_alg = kappa_alg, w_pp_cutoff = w_pp_cutoff, min_w_bb = min_w_bb, w_bb_cutoff = w_bb_cutoff, fleetDynamics=TRUE, selectivity_params = selectivity_params, catchability = df_target_unfished, target = df_target_unfished)

# params_unfished@selectivity
 
# sim_unfished <- project(params_unfished, effort = 0, dt = dt, fleetDynamics = TRUE, management = TRUE, multiFleet = FALSE, price = price_forward, cost = cost_forward, diet_steps = 0, ke = ke, initial_effort = initial_effort_scenario, scaling_price = scaling_price, Blevel_management = Blevel_management, initial_n = initial_n_scenario, initial_n_pp = initial_n_pp_scenario , initial_n_bb = initial_n_bb_scenario )

# plotFleet(sim_unfished) # effort and profits are calcualted anyway - it's OK fixed below   
# plotBiomass(sim_unfished)$plot + facet_wrap(~Species)

######## no competition
df_target_NoCompetition<-target
trial<-colMaxs(df_target_NoCompetition)
trial<-trial[-which(trial == 0)]
df_target_NoCompetition[df_target_NoCompetition %in% trial]<-1
df_target_NoCompetition[df_target_NoCompetition != 1]<-0

# trial 2 - keep Fmort on each target spp constant, just  moved from all fleet to 1 fleet 
div<-colSums(df_target_NoCompetition*initial_effort_scenario)/colSums(target*initial_effort_scenario)
df_target_NoCompetition<-sweep(df_target_NoCompetition, 2, div, FUN = '/')
df_target_NoCompetition[, "myctophids"]<-0  

colSums(df_target_NoCompetition*initial_effort_scenario)
colSums(target*initial_effort_scenario)

######## full competition 
df_target_FullCompetition<-target
df_target_FullCompetition[]<-1
df_target_FullCompetition[, "myctophids"]<-0  
# df_target_FullCompetition[, "trachurus declivis"]<-0
# df_target_FullCompetition[, "nototodarus gouldi"]<-0
# df_target_FullCompetition[, "helicolenus barathri"]<-0
# df_target_FullCompetition[df_target_FullCompetition!=0]<-1 # this would be the best, but results are difficult to interpret....

# trial 2 - as above
div<-colSums(df_target_FullCompetition*initial_effort_scenario)/colSums(target*initial_effort_scenario)
df_target_FullCompetition<-sweep(df_target_FullCompetition, 2, div, FUN = '/')
df_target_FullCompetition[, "myctophids"]<-0  

# colSums(df_target_FullCompetition*initial_effort_scenario)
# colSums(target*initial_effort_scenario)

######## no bycatch (and spp under rebilding strategies) 
# NOTE: 2 fisheries are based on spp under recovery strategies - OR and school shark
df_target_NoBycatch<-target
# what's bycatch? the 2 fleets with lowest proportion of catches should not catch the spp? 

df<-target
for(i in 1:ncol(df)){
  df<-df[order(df[,i]),]
  df[c(1,2),i]<-0
}
df<-df[c(2,1,3,4,5),]
df_target_NoBycatch<-df

# trial 2 - as above
div<-colSums(df_target_NoBycatch*initial_effort_scenario)/colSums(target*initial_effort_scenario)
df_target_NoBycatch<-sweep(df_target_NoBycatch, 2, div, FUN = '/')
df_target_NoBycatch[, "myctophids"]<-0  

# this applied to both trial 1 and 2.... Should this be done? cacth is not kept stable this way...
# df_target_NoBycatch[, "seriolella brama"] <- 0 # rebuilding
# df_target_NoBycatch[, "rexea solandri"] <- 0 # rebuilding
# df_target_NoBycatch[, "hoplostethus atlanticus"] <- 0 # rebuilding or not really?
# df_target_NoBycatch[, "galeorhinus galeus"] <- 0 # rebuilding

colSums(df_target_NoBycatch*initial_effort_scenario)
colSums(target*initial_effort_scenario)

######## target more target - see options    
# define (main target and?) most valuable spp and increase fishing on these by the fleets that already catch them - by 50% - working, set to 1 - not working 
# yes I have checked prices according to data and they match with sharks being the higehst value spp. 
valuable<-sort(-df_price_new[nrow(df_price_new),])
valuable<-names(valuable)[1:6]

# # option 1 
# df_target_MoreTarget<-as.data.frame(target) %>% 
#   mutate(fleet = rownames(target)) %>% 
#   gather(key = "species", value = "interaction", - fleet) %>% 
#   mutate(interaction = ifelse(species %in% valuable & interaction > 0, interaction*2, interaction))
# df_target_MoreTarget<-acast(df_target_MoreTarget, fleet ~ species) 

# option 2 - increase Fmort of valuable by 50% of current Fmort adn spread taht  increase across fleets proportionally
df_target_MoreTarget<-target
a<-colSums(target[,valuable]*initial_effort_scenario) 
a<-a + (a*0.5) # plus 50% ? 
div<-colSums(df_target_MoreTarget[,valuable]*initial_effort_scenario)/a
df_target_MoreTarget[,valuable]<-sweep(df_target_MoreTarget[,valuable], 2, div, FUN = '/')

colSums(df_target_MoreTarget*initial_effort_scenario)
colSums(target*initial_effort_scenario)

######## target more underquota   
# define under quota spp and increase fishing on these. https://www.afma.gov.au/sites/default/files/semac_tac_recommendations_2019-20.pdf
# undercaught TAC is a performance indicator of the fishery - can be added to the socio-economic ones? 
under<-c("macruronus novaezelandiae","nemadactylus macropterus","zeus faber","pristiophorus cirratus") # Jackass morwong is a bit funny as it's declining and there are no data for assessment. redfish?! recovery or undercaught? shawshrk is low values, not overfished 

# # option 1 
# df_target_MoreUnderQuota<-as.data.frame(target) %>% 
#   mutate(fleet = rownames(target)) %>% 
#   gather(key = "species", value = "interaction", - fleet) %>% 
#   mutate(interaction = ifelse(species %in% under & interaction > 0, interaction*2, interaction))
# df_target_MoreUnderQuota<-acast(df_target_MoreUnderQuota, fleet ~ species) 

# option 2 - increase Fmort of valuable by 50% of current Fmort adn spread taht  increase across fleets proportionally
df_target_MoreUnderQuota<-target
a<-colSums(target[,under]*initial_effort_scenario) 
a<-a + (a*0.5) # plus 50% ? 
div<-colSums(df_target_MoreUnderQuota[,under]*initial_effort_scenario)/a
df_target_MoreUnderQuota[,under]<-sweep(df_target_MoreUnderQuota[,under], 2, div, FUN = '/')

colSums(df_target_MoreUnderQuota*initial_effort_scenario)
colSums(target*initial_effort_scenario)

####### runs 
target_scenario = list(unfished = df_target_unfished, noCompetition = df_target_NoCompetition, fullCompetition = df_target_FullCompetition, statusQuo = target, noBycatch = df_target_NoBycatch, MoreTarget = df_target_MoreTarget, MoreUnderQuota = df_target_MoreUnderQuota) # best = df_target_best)

# new scenarios 

new_inter<-list()

for (i in 1:ncol(target)){
  
  new_inter[[i]]<-target
  new_inter[[i]][,i]<-df_target_NoCompetition[,i]
  names(new_inter)[i]<-colnames(target)[i]
  
  }

new_inter$myctophids<-NULL


# add new scenarios to old list 

target_scenario<-c(target_scenario,new_inter)

# run scenarios 
params_scenario<-list()
sim_scenario<-list()

for(i in 1:length(target_scenario)){
  
  # i = 4
  params_scenario[[i]] <- MizerParams(df_param2,
                            interaction = theta, 
                            kappa = kappa,
                            kappa_ben = kappa_ben, 
                            kappa_alg = kappa_alg, 
                            w_pp_cutoff = w_pp_cutoff,
                            min_w_bb = min_w_bb, 
                            w_bb_cutoff = w_bb_cutoff, 
                            fleetDynamics = TRUE, 
                            selectivity_params = selectivity_params,
                            catchability = target_scenario[[i]],
                            target = target_scenario[[i]])

  sim_scenario[[i]] <- project(params_scenario[[i]], 
                      effort = 0, 
                      dt = dt, 
                      fleetDynamics = TRUE, 
                      management = TRUE, 
                      multiFleet = FALSE,
                      price = price_forward, 
                      cost = cost_forward, 
                      diet_steps = 0, 
                      ke = ke,  
                      initial_effort = initial_effort_scenario,
                      scaling_price = scaling_price,
                      Blevel_management = Blevel_management,
                      initial_n = initial_n_scenario,
                      initial_n_pp = initial_n_pp_scenario, 
                      initial_n_bb = initial_n_bb_scenario)
  
  names(sim_scenario)[i]<-names(target_scenario)[i]
  
}

# check one by one

# # plotFleet(sim_scenario$unfished)
# plotFleet(sim_scenario$noCompetition) # declines in effort and yield despite increases in abundance - why? are declines driven by profits instead of management? when decreases are weigthed by contribution to cacthes they are multiplied by 1 instead of e.g. 0.01 and thus are bigger... (i.e. if a spp contributes a little than the decrease is small, if it contributes a lot - Q=1 - then decreases are bigger). this is the problem with SH, which is forced to steeply decrease because platy has a Q of 1 and is below 20. when platy recovers, changes in effort are less steep.
# plotFleet(sim_scenario$fullCompetition) # collapses
# plotFleet(sim_scenario$statusQuo) # some recoveries and increases
# plotFleet(sim_scenario$noBycatch) # recoveries and increases in trends
# plotFleet(sim_scenario$MoreTarget) # collapses
# plotFleet(sim_scenario$MoreUnderQuota) # collapses

# why collapses? because more than 4 spp are below 20! fleet collapses mean spp recoveries....
a<-sim_scenario$MoreUnderQuota
# plotFleet(a)
# plotBiomass(a)$plot + facet_wrap(~Species)
# managemtn
pr <- a@BioOut[[24]] %>%
  filter(bioLim == "bio20check", fleet == "SET-SH")
unique(pr$species)

a@effortOut
a@profit

# catchComp(sim_FD = sim_scenario$statusQuo, df_log_spp)
trial<-a@yield
trial<-rowSums(aperm(trial,c(1,2,4,3)),dims=3) # sum over size
trial<-as.data.frame.table(trial, responseName = "yield")
colnames(trial)<-c("year", "species","fleet", "yield")
trial<-trial%>%
  left_join(df_param[,c(1,2)]) %>% 
  filter(fleet == "SET-SH", yield >0)

ggplot(filter(trial),aes(x=year, y = yield, fill=species)) +
  geom_bar(position = "stack", stat = "identity") +
  theme_bw() +
  facet_wrap(~fleet, scale = "free")

```

#-----------------------------------------
# scenarios management *skyp*  
#----------------------------------------------

```{r}
# explore managemtn options - open access, HRC, save the small and save the big.

# params_OA <- MizerParams(df_param,
#                           interaction = theta, 
#                           kappa = kappa,
#                           kappa_ben = kappa_ben, 
#                           kappa_alg = kappa_alg, 
#                           w_pp_cutoff = w_pp_cutoff,# should be 'new' here but may not matter
#                           min_w_bb = min_w_bb, 
#                           w_bb_cutoff = w_bb_cutoff, 
#                           fleetDynamics = TRUE, 
#                           selectivity_params = selectivity_params,
#                           catchability = catchability,
#                           target = target)
# 
# sim_OA<- project(params_OA, 
#                       effort = 0, 
#                       dt = 0.5, 
#                       fleetDynamics = TRUE, 
#                       management = FALSE, # problem here.... 
#                       price = price_forward, 
#                       cost = cost_forward, 
#                       diet_steps = 0, 
#                       ke = ke, # should be calibrated here  
#                       initial_n = initial_n_scenario,
#                       initial_n_pp = initial_n_pp_scenario, 
#                       initial_n_bb = initial_n_bb_scenario, 
#                       initial_effort = initial_effort_scenario, 
#                       scaling_price = scaling_price, # should be calibrated values here 
#                       Blevel_management = Blevel_management)
# 
# 
# # plotFleet(sim_OA)
# # plot_CN(sim_OA)
# 
# # explore management
# 
# # HCR to target spp only
# 
# # NOTE: catchability is used to determine which spp each fleet catches (getFmortGear()); target is used to select which spp are under management (in management component)).
# 
# df_target_management<-df_target_bmsy
# df_target_management[, c("centroberyx affinis","helicolenus barathri","myctophids","nototodarus gouldi","pristiophorus cirratus","squalus spp.","trachurus declivis","zeus faber")]<-0
# 
# params_HCR <- MizerParams(df_param,
#                             interaction = theta,
#                             kappa = kappa3,
#                             kappa_ben = kappa_ben,
#                             kappa_alg = kappa_alg,
#                             w_pp_cutoff = w_pp_cutoff,
#                             min_w_bb = min_w_bb,
#                             w_bb_cutoff = w_bb_cutoff,
#                             fleetDynamics = TRUE,
#                             selectivity_params = df_selParam_new,
#                             catchability = df_target_bmsy,
#                             target = df_target_management)
# 
# sim_HCR<- project(params_HCR,
#                       t_max = t_max,
#                       effort = 0,
#                       dt = 0.5,
#                       fleetDynamics = TRUE,
#                       management = TRUE,
#                       price = df_price_new,
#                       cost = df_cost_mean2,
#                       diet_steps = 0,
#                       ke = ke,
#                       initial_n = initial_n,
#                       initial_n_pp = initial_n_pp,
#                       initial_n_bb = initial_n_bb,
#                       initial_effort = initial_effort,
#                       scaling_price = scaling_price,
#                       Blevel_management = Blevel_management)
# 
# plotFleet(sim_FD)
# plotFleet(sim_HCR)
# plot_CN(sim_FD)
```

#-----------------------------------------
# size limits *move to Multifleet_example* 
#----------------------------------------------

```{r}

# names(sim_scenario)
# 
# # selectivity - save small individuals
# params_saveSmall<-sim_scenario$statusQuo@params # params where target and catchability is as per status quo 
# dim(params_saveSmall@selectivity)
# params_saveSmall@selectivity[1,5,] # fleet, species, size 
# params_saveSmall@selectivity[,,1:71]<-0 # this needs to be species-specific!
# 
# saveSmall <- project(params_saveSmall, 
#                       effort = 0, 
#                       dt = dt, 
#                       fleetDynamics = TRUE, 
#                       management = TRUE, 
#                       multiFleet = FALSE,
#                       price = price_forward, # running with price and cost data between 2006 and 2017 as per above 
#                       cost = cost_forward, 
#                       diet_steps = 0, 
#                       ke = ke,  
#                       initial_n = initial_n_scenario, # running with values from 2006 as per above
#                       initial_n_pp = initial_n_pp_scenario, 
#                       initial_n_bb = initial_n_bb_scenario, 
#                       initial_effort = initial_effort_scenario, 
#                       scaling_price = scaling_price, 
#                       Blevel_management = Blevel_management)
# 
# plot_CN(saveSmall)
# plotFleet(saveSmall)
# plotFleet(sim_scenario$statusQuo)
# 
# # selectivity - save big individuals
# params_saveBig<-sim_scenario$statusQuo@params
# params_saveBig@selectivity[,,90:100]<-0 
# 
# saveBig <- project(params_saveBig, 
#                       effort = 0, 
#                       dt = 0.5, 
#                       fleetDynamics = TRUE, 
#                       management = TRUE, 
#                       price = price_forward, # running with price and cost data between 2006 and 2017 as per above 
#                       cost = cost_forward, 
#                       diet_steps = 0, 
#                       ke = ke,  
#                       initial_n = initial_n_scenario, # running with values from 2006 as per above
#                       initial_n_pp = initial_n_pp_scenario, 
#                       initial_n_bb = initial_n_bb_scenario, 
#                       initial_effort = initial_effort_scenario, 
#                       scaling_price = scaling_price, 
#                       Blevel_management = Blevel_management)
# 
# plot_CN(saveBig)
# plotFleet(saveBig)
# plotFleet(sim_scenario$statusQuo)
# 
# sim_saveBig@effortOut[t_max,]
# 
# BioOut<-do.call("rbind",saveBig@BioOut)
# BioOut40<-BioOut[BioOut$time == t_max & BioOut$bioLim %in% c("bio40check"),]
# BioOut20<-BioOut[BioOut$time == t_max & BioOut$bioLim %in% c("bio20check"),]

```

# TO DO 

See ecovariability paper 
objectives (i.e. expressed in managemtn rules): 
1. blim
2. yiled lim
3. profit positive for all fleets

scenarios: 
1. fleets driven by current effort and managemtn is off
2. MEY - fleets driven by profits and Blim on
3. minimise bioeconomic risk of vulnerability - all management rules applied  

indicators:  
1. net present value (i.e. profits - economic)
2. meeting objectives (Blim, yiled lim and profit > 0 - ecoviablility only for scenario 3)
3. richness, trophic index, simpson (ecological)

my model: 
objectives: 
1. blim
2. maximise profits (not care about fleet profitability)

scenario: 
1. full competition 
2. no competition ... 

indicators: 
1. yield (in my case not an objective but an indicators), effort, profit
2. meeting objectives (n spp above Blim, could aslo do n fleet active but not an objective)
3. biomass (better not as it's in management)
4. slope and trophic level  


#-----------------------------------------
# plots of comparison 
#----------------------------------------------


```{r}

# quick plots - copy and paste from below or plot inside DataFunction.R 
library("purrr")
indi<-indicators(sim_scenario)
df_plot = indi$df_plot


  # or not - if you are using plot type 2 - TRIAL! 
  df_plot2<-df_plot
  
  # calculate sp below re limits adn N of active vessels for each scenario
  Ntext<-df_plot2 %>% 
    select(c(scenario, Nref)) #%>%
  Ntext$Nref<-paste("Below Bmsy = ", Ntext$Nref)
  
  N20text<-df_plot2 %>% 
    select(c(scenario, Nref20)) #%>%
  N20text$Nref20<-paste("Below 20% = ", N20text$Nref20)
  
  Ftext<-df_plot2 %>% 
    select(c(scenario, Fref)) #%>%
  Ftext$Fref<-paste("Active = ", Ftext$Fref)
  
  # color, order and rename indicators and scenarios
  c = c("Nref","Nref20","Fref","biomassB","biomassA","slope","effort","yield","profit")
  d = c("Nref","Nref20","Fref","Biomass","Bio recovery", "Slope", "Effort", "Yield", "Profit")
  
  df_plot3<- df_plot2 %>% 
    gather(indicator, value, -scenario) %>% 
    mutate(type = ifelse(indicator %in% c("biomassA","biomassB","slope"),"ecological","socio-economic")) 
  
  # version as per China paper 
  df_plot6<-df_plot3
  df_plot6$indicator<-as.character(df_plot6$indicator)
  df_plot6$indicator<-ifelse(df_plot6$indicator == "Bio recovery", "Bio_recovery", df_plot6$indicator)

  df_plot6<-df_plot6 %>% 
    select(!type) %>% 
    spread(indicator,value) %>% 
    mutate(scenario = as.character(scenario)) %>% 
    mutate(yield = (yield/1000000)*areaEco, 
           biomassB = (biomassB/1000000)*areaEco,
           biomassA = (biomassA/1000000)*areaEco, 
           profit = (profit*areaEco)/1000000) # need to re-think and check this one... it is now million $ per ecosystems and teh starting value should be $ per m3 


  # create a dummy variable for legend 
  # df_plot6<-df_plot6 %>% 
  #   add_row(scenario="Legend", biomassA = NA, biomassB = 900000, effort = NA, Fref = NA, Nref =NA, Nref20 = NA, profit = min (df_plot6$profit), slope = NA, yield = max(df_plot6$yield))
  
  # are these values matching at the fishery scale? - to check: tonnes sounds about right, profits are too high (but it's the relative difference that  matters... )
  
  df_plot7<-df_plot6 %>%
    filter(!scenario %in% c("fullCompetition", "noCompetition", "unfished","noBycatch","MoreUnderQuota","MoreTarget"))

  trial<-ggplot(data = df_plot7, aes(x = yield, y = profit, color = scenario))+ 
    geom_label(aes(label = scenario))+
    geom_point(aes(size=biomassB))+
    # scale_size_continuous(range = c(10, 15))+
    # geom_text(aes(label = round(biomassB)))+

    scale_fill_manual(values = , name = "Scenario", guide=FALSE)+
    # expand_limits(x = c(min(df_plot6$yield, na.rm = TRUE)-1000, max(df_plot6$yield,na.rm = TRUE)+1000), y = c(min(df_plot6$profit)-5, max(df_plot6$profit)+5))+
    theme_bw()+
    ylab ("Profits [million $]")+
    xlab ("Yield [tonnes]")+
    theme(text = element_text(size=18),
          axis.title.y = element_text(vjust=0.4, size = 16),
          axis.title.x = element_text(vjust=0.3, size = 16),
          axis.text.x = element_text(angle=90, hjust=0.5),
          panel.grid.major = element_blank(), 
          strip.background = element_blank(),
          panel.border = element_rect(colour = "black"),
          strip.text.x = element_text(face = "bold"),
          # legend.position = c(0.9, 0.3))
          legend.position = "none") # strip.text.x = element_blank())
trial

# NEXT STEP

# how to rank scenarios?
# first by yield 
# the by profits 
# the by biomass 

# when you rank by yield: add the the first 2 spp together and run a new sceanrio, then the 3 spp and runa  new scenario etc... you will get to the  no competition one 
# do the same with profits and  with biomass. Are the pathways to get to the no competition one different? this is a prioritization scheme these type of analysis are done for foodwebs - e.g. remove weak links and see what happens.   


# plot scenarios
plotFleet(sim_scenario$`platycephalus richardsoni`)
plot_CN(plotFleet(sim_scenario$`platycephalus richardsoni`))
plotFleet(sim_scenario$`trachurus declivis`)



























# save and upload data here 
# you might need just these: target_scenario, params_scenario, sim_scenario... the one you saved is big!
# save.image(file = "/Users/nov017/Dropbox/Mizer-fleet_extension/data/FDScenarios.RData") 
# load("/Users/nov017/Dropbox/Mizer-fleet_extension/data/FDScenarios.RData")

### delete unfished as not used
sim_scenario$unfished<-NULL
# some fixes: 
# sim_scenario[["unfished"]]@effortOut[]<-0 # beaause initial_effort was still 0.1 though catches are 0 due to df_target
# sim_scenario[["unfished"]]@profit[]<-0 # because fixed costs were still there 
# sim_scenario[["unfished"]]@revenue[]<-0 # becasue of the above 

# Calculate indicators at last run of scenarios - whole fishery level 
library("purrr")
indi<-indicators(sim_scenario)
df_plot = indi$df_plot

# order of scenarios
a = c("statusQuo","noCompetition","fullCompetition","noBycatch","MoreTarget","MoreUnderQuota")
b = c("Status Quo","No Competition","Full Competition", "Less Bycatch","More Valuable","More Under-Quota")
# col_values<-c("#084594", "#2171b5", "#eff3ff", "#c6dbef", "#9ecae1", "#6baed6", "#4292c6") # https://colorbrewer2.org/#type=sequential&scheme=Blues&n=7
col_values<-c("#08589e", "#2b8cbe", "#4eb3d3", "#7bccc4", "#a8ddb5", "#ccebc5", "#f0f9e8") # https://colorbrewer2.org/#type=sequential&scheme=Blues&n=7

col_values2<-c("#cb181d")
col_values3<-c("#7fbf7b","#af8dc3")

# plot fishing effort by fleet
plot_effort = plotFleetEffort(a,b, sim_scenario, sim_FD_bmsy, col_values[1:5])$plot_effort
plot_effort

# plot interaction matrix
# problems - differences between interactions matrices are not very visible. See proposed solutions inside function
# problem with  calcualtion of Q (see inside function): cumulative Fmort across fleet set as per status quo (Q*initial_effort). Effort is dynamic but Q is not (e.g. high Q for fatheads in full competition, if effort increases for some fleets, pressure increases a lot for this spp). Need to revisit?
library("tidyr")
plot_matrix = plotFleetMatrix(a,b,target_scenario, col_values2)$plot_matrix # new plot with different colors 

# plot indicators - fishery level 
plot_bar_reduced = plotIndicators(a,b,df_plot, col_values3)$plot_bar_reduced # this one 
plot_bar_reduced
plot_trial = plotIndicators(a,b,df_plot, col_values3)$trial # NEW ONE to be fixed  

# all plots 
library(patchwork)
# setwd("/Users/nov017/Dropbox/Mizer-fleet_extension/plot/FD/Final")
# tiff("Fig6_May2020C.tiff", height=13, width=16, units ='in', res=300)
# plot_matrix / plot_bar + plot_layout (nrow = 2, heights = c(2,2))
plot_matrix / plot_effort / plot_bar_reduced + plot_layout (nrow = 3, heights = c(2.2,1.4,1.4))
# dev.off()


```

# TO DO BETH

FIRST - OK
decreases in effort - per broken stick 
A most limiting spp set effort reduction - reduce effort according to the species that is below msy - reduce by the amount of the depletion (e.g. by 10% is the spp is depleted by 10%)
B mean (which mean? up to you) of any reduction: 
effort scaler = 1/3 (a + b + c) - TRIED 
effort scaler = cube root of (a * b * c) 
effort scaler = (a*Ba + b*Bb + c*Bc)/(Ba + Bb + Bc) = weighted sum of contributing species
if B is on, then you don't need the 20% rule 

SECOND OK  
burning period or stabilzations at the FD level - don't do it as you are missing the dynamics and taking/exploring the system at another level.  

THIRD
fleet behaviour rule before the managetmn if thinkgs are still not working as expected...
E ~ profit -> if profit < lower bound, reduce effort by a certain % and vice versa. figure out the bound looking at CPUE and effort. 

FIFTH
plot of relative biomass vs bmsy and Blim for each stock and scenario
time series of effort levels - as for plotFleet()

SIXTH
in the time variant but relevant in genetal, effort might not dcrease even if profits do becasue changes in costs produce a very low change in effort e.g. 0.00000001 that is too low to be reflected in profits. Need to change the price something? need to think about this!!! 

SEVENTH - OK
do not consider MTL as it has many problems.... change with others

#-----------------------------------------
# additional plots 
#----------------------------------------------

```{r}

# function to plot model runs - species with biomass limits 
plot_limits<-function(temp_sim){
  
  BioLim<-temp_sim@BioLimits[[4]]$SED # limits don't change across fleet, time and scenarios 
  BioLim<-BioLim %>% 
    left_join(df_param[,c(1,2)]) 
  
  BioData<-plotBiomass(temp_sim)$BioData
  colnames(BioData)<-c("time","species","value")
  BioData<-BioData %>% 
    left_join(df_param[,c(1,2)])
  
  # order factors 
  a = unique(BioData$spCommon)
  BioData<-BioData %>% 
    mutate(spCommon = factor(spCommon, level = a))
  BioLim<-BioLim %>% 
    mutate(spCommon = factor(spCommon, level = a))
  
  x_label <- "Year"
  y_label <- "Biomass [g]"
  
  p <- ggplot(BioData, aes(x = time, y = value)) +
    scale_y_continuous(trans = "log10", name = y_label) +
    scale_x_continuous(name = x_label) +
    geom_line() + 
    geom_hline(data = BioLim, aes(yintercept = bio20), linetype = "dotdash", color = "red")+
    geom_hline(data = BioLim, aes(yintercept = bio40), linetype = "dashed", color = "green")+
    geom_hline(data = BioLim, aes(yintercept = bio48), linetype = "dotted", color = "blue")+
    theme_bw()+
    theme(text = element_text(size=18),
          axis.title.y = element_text(vjust=0.4, size = 16),
          axis.title.x = element_text(vjust=0.3, size = 16),
          axis.text.x = element_text(angle=90, hjust=0.5),
          panel.grid.major = element_blank(), 
          strip.background =element_rect(fill="white"),
          legend.position = "none")+
    facet_wrap(~spCommon)
  
  return(p)
}

# function to plot model runs - fleets effort, profits, yield etc.  

plot_fleet<-function(temp_sim){
  
  eData<-plotEffort_CN(temp_sim)$eData
  colnames(eData)<-c("time","fleet","Effort [m]")
  yData<-plotYield_CN(temp_sim)$yData
  colnames(yData)<-c("time","fleet","Yield [g]")
  prData<-plotProfit_CN(temp_sim)$prData
  colnames(prData)<-c("time","fleet","Profit [$]")

  fleetData<-merge(eData, yData, all = TRUE)
  fleetData<-merge(fleetData, prData, all = TRUE)
  fleetData<-fleetData %>%
    gather(key, value, -time, -fleet)

  x_label <- "Year"
  p <- ggplot(fleetData, aes(x = time, y = value)) +
    scale_x_continuous(name = x_label) +
    geom_line() +
    theme_bw()+
    theme(text = element_text(size=18),
          axis.title.y = element_blank(), 
          axis.title.x = element_text(vjust=0.3, size = 16),
          axis.text.x = element_text(angle=90, hjust=0.5),
          panel.grid.major = element_blank(),
          strip.background =element_rect(fill="white"),
          legend.position = "none")+
    facet_grid(key~fleet, scale = "free")
  
  return(p)
}

# run function over each scenario 

plot_SI_sim_scenario<-list()

for(i in 1:length(sim_scenario)){
  
  # i = 1
  a<-plot_limits(sim_scenario[[i]])
  b<-plot_fleet(sim_scenario[[i]])
  # library(patchwork)
  plot_SI_sim_scenario [[i]]<- a / b + plot_layout (nrow = 2, heights = c(1.5,1))
  
  names(plot_SI_sim_scenario)[i]<-names(sim_scenario)[i]
  
}

# not working! only manually.... 

for(i in 1:length(plot_SI_sim_scenario)){
 
  i = 6
  # setwd("/Users/nov017/Dropbox/Mizer-fleet_extension/plot/FD/Final")
  # tiff(paste("FigS3_",names(plot_SI_sim_scenario)[i],".tiff", sep = "" ), height=10, width=10, units ='in', res=300)
  plot_SI_sim_scenario[[i]]
  # dev.off()
  
}

```

